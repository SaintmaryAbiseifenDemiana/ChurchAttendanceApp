<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ÙˆØ§Ù„Ø³Ù†ÙˆÙŠØ© Ù„Ù„Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ†</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { text-align: center; padding: 5px; border: 1px solid #ccc; }
    th { background-color: #007bff; color: white; }
    .summary-table {
      display: none; /* ÙŠØ®ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
}
    #monthlySummaryTitle {
      display: none;
}

   /* Ø£Ù„ÙˆØ§Ù† ÙØ§ØªØ­Ø© Ù„ÙƒÙ„ Ø´Ù‡Ø± */
.month-col-0 { background-color: #f9f9f9; }   /* Ø£ÙƒØªÙˆØ¨Ø± */
.month-col-1 { background-color: #fef6e4; }   /* Ù†ÙˆÙÙ…Ø¨Ø± */
.month-col-2 { background-color: #eaf4fc; }   /* Ø¯ÙŠØ³Ù…Ø¨Ø± */
.month-col-3 { background-color: #f0f9eb; }   /* ÙŠÙ†Ø§ÙŠØ± */
.month-col-4 { background-color: #fff0f6; }   /* ÙØ¨Ø±Ø§ÙŠØ± */
.month-col-5 { background-color: #fdfde7; }   /* Ù…Ø§Ø±Ø³ */
.month-col-6 { background-color: #e8f7f5; }   /* Ø£Ø¨Ø±ÙŠÙ„ */
.month-col-7 { background-color: #f9f0ff; }   /* Ù…Ø§ÙŠÙˆ */
.month-col-8 { background-color: #f0f8ff; }   /* ÙŠÙˆÙ†ÙŠÙˆ */
.month-col-9 { background-color: #f6fff0; }   /* ÙŠÙˆÙ„ÙŠÙˆ */
.month-col-10 { background-color: #fffaf0; }  /* Ø£ØºØ³Ø·Ø³ */
.month-col-11 { background-color: #f0ffff; }  /* Ø³Ø¨ØªÙ…Ø¨Ø± */
/* Ø®Ø· Ø³Ù…ÙŠÙƒ Ø¨ÙŠÙ† ÙƒÙ„ Ø®Ø§Ø¯Ù… */
.servant-separator td {
  border-top: 3px solid #000; /* Ø®Ø· Ø£Ø³ÙˆØ¯ Ø³Ù…ÙŠÙƒ */
}

  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Ù†Ø³Ø¨ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ†</h1>

    <div class="filters">
      <label for="monthSelect">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
      <select id="monthSelect">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± --</option>
        <option value="01">ÙŠÙ†Ø§ÙŠØ±</option>
        <option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option>
        <option value="03">Ù…Ø§Ø±Ø³</option>
        <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option>
        <option value="05">Ù…Ø§ÙŠÙˆ</option>
        <option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
        <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option>
        <option value="08">Ø£ØºØ³Ø·Ø³</option>
        <option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
        <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
        <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
        <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
      </select>

      <label for="familySelect">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø±Ø©:</label>
      <select id="familySelect">
        <option value="">-- Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø±... --</option>
      </select>

      <button id="loadMonthlyBtn">Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</button>
      <button id="loadYearlyBtn">Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©</button>
    </div>

    <!-- Ù‡Ù†Ø§ Ù‡Ù†Ø­Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div id="servantsBlocks"></div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø±Ø© Ù„Ù„Ø´Ù‡Ø±ÙŠ ÙÙ‚Ø· -->
    <h3 id="monthlySummaryTitle">ğŸ“Œ Ù†Ø³Ø¨Ø© Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø³Ø±Ø© ÙÙŠ Ø§Ù„Ø´Ù‡Ø±</h3>

    <table class="table summary-table">
      <thead>
        <tr>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ†</th>
          <th>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù…Ø¹</th>
          <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
        </tr>
      </thead>
      <tbody id="familySummaryBody"></tbody>
    </table>
  </div>

  <script>
    const API_BASE = '/api';

    document.addEventListener('DOMContentLoaded', () => {
      loadFamilies();
      document.getElementById('loadMonthlyBtn').addEventListener('click', loadMonthlyReport);
      document.getElementById('loadYearlyBtn').addEventListener('click', loadYearlyReport);
    });

    // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¬Ù…Ø¹Ø© ÙÙŠ Ø´Ù‡Ø±/Ø³Ù†Ø©
    function countFridaysInMonth(monthStr, yearNum) {
      const month = parseInt(monthStr, 10) - 1;
      const date = new Date(yearNum, month, 1);
      let fridays = 0;
      while (date.getMonth() === month) {
        if (date.getDay() === 5) fridays++;
        date.setDate(date.getDate() + 1);
      }
      return fridays;
    }

  async function loadYearlyReport() {
    const familyId = document.getElementById('familySelect').value;
    const blocksDiv = document.getElementById('servantsBlocks');
    const summaryTable = document.querySelector('.summary-table');


    if (!familyId) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹.');
        return;
    }
    summaryTable.style.display = 'none';
    document.getElementById('monthlySummaryTitle').style.display = 'none';

    blocksDiv.innerHTML = '';

    // ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ± Ù…Ù† Ø£ÙƒØªÙˆØ¨Ø± 2025 Ø­ØªÙ‰ Ø³Ø¨ØªÙ…Ø¨Ø± 2026 Ù…Ø¹ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ„ Ø´Ù‡Ø±
    const months = [
        { value: "10", label: "Ø£ÙƒØªÙˆØ¨Ø± 2025", year: 2025 },
        { value: "11", label: "Ù†ÙˆÙÙ…Ø¨Ø± 2025", year: 2025 },
        { value: "12", label: "Ø¯ÙŠØ³Ù…Ø¨Ø± 2025", year: 2025 },
        { value: "01", label: "ÙŠÙ†Ø§ÙŠØ± 2026", year: 2026 },
        { value: "02", label: "ÙØ¨Ø±Ø§ÙŠØ± 2026", year: 2026 },
        { value: "03", label: "Ù…Ø§Ø±Ø³ 2026", year: 2026 },
        { value: "04", label: "Ø£Ø¨Ø±ÙŠÙ„ 2026", year: 2026 },
        { value: "05", label: "Ù…Ø§ÙŠÙˆ 2026", year: 2026 },
        { value: "06", label: "ÙŠÙˆÙ†ÙŠÙˆ 2026", year: 2026 },
        { value: "07", label: "ÙŠÙˆÙ„ÙŠÙˆ 2026", year: 2026 },
        { value: "08", label: "Ø£ØºØ³Ø·Ø³ 2026", year: 2026 },
        { value: "09", label: "Ø³Ø¨ØªÙ…Ø¨Ø± 2026", year: 2026 }
    ];

    const yearlyServiced = {};

    for (const m of months) {
        // Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù…Ø¹ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø­Ø³Ø¨ Ø³Ù†Ø© Ø§Ù„Ø´Ù‡Ø±
        const fridaysInThisMonth = countFridaysInMonth(m.value, m.year);

        const response = await fetch(`${API_BASE}/admin/monthly-serviced/${m.value}/${familyId}`);
        const data = await response.json();

        if (data.success && Array.isArray(data.serviced)) {
            console.log("MONTH", m.label, data.serviced);

            data.serviced.forEach(s => {
                const presentCount = s.sessions.filter(x => x.status === 'Present').length;

                if (!yearlyServiced[s.servant_name]) yearlyServiced[s.servant_name] = [];

                let existing = yearlyServiced[s.servant_name].find(x => x.serviced_name === s.serviced_name);
                if (!existing) {
                    existing = {
                        serviced_name: s.serviced_name,
                        monthly: {},
                        totalPresent: 0
                    };
                    yearlyServiced[s.servant_name].push(existing);
                }

                existing.monthly[m.label] = {
                    present: presentCount,
                    fridays: fridaysInThisMonth,
                    percentage: fridaysInThisMonth > 0 ? Math.round((presentCount / fridaysInThisMonth) * 100) : 0
                };

                existing.totalPresent += presentCount;
            });
        }
    }

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù…Ø¹ Ù„ÙƒÙ„ Ø§Ù„Ø³Ù†Ø©
    const totalFridaysYear = months.reduce((sum, m) => sum + countFridaysInMonth(m.value, m.year), 0);

    const table = document.createElement('table');
    table.className = 'table table-bordered';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ø¯Ù…</th>
                <th>Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…</th>
                ${months.map(m => `<th>${m.label}</th>`).join('')}
                <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©</th>
            </tr>
        </thead>
        <tbody>
          ${Object.entries(yearlyServiced).map(([servantName, records]) => {
    return records.map((s, index) => {
        const yearlyPercentage = totalFridaysYear > 0
            ? Math.round((s.totalPresent / totalFridaysYear) * 100)
            : 0;

        return `
            <tr class="${index === 0 ? 'servant-separator' : ''}">
                ${index === 0 ? `<td rowspan="${records.length}">${servantName}</td>` : ''}
                <td>${s.serviced_name}</td>
                ${months.map((m, i) => {
                    const cell = s.monthly[m.label];
                    return `<td class="month-col-${i}">${cell ? cell.percentage + '%' : '0%'}</td>`;
                }).join('')}
                <td>${yearlyPercentage}%</td>
            </tr>
        `;
    }).join('');
}).join('')}

        </tbody>
    `;
    blocksDiv.appendChild(table);
}



    async function loadFamilies() {
      const select = document.getElementById('familySelect');
      select.innerHTML = '<option value="">-- Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø±... --</option>';
      select.disabled = true;

      try {
        const response = await fetch(`${API_BASE}/families`);
        const data = await response.json();

        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø±Ø© --</option>';

        if (data.success && data.families.length > 0) {
          data.families.forEach(f => {
            const option = new Option(f.family_name, f.family_id);
            select.add(option);
          });
        } else {
          const option = new Option('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø± Ù…Ø³Ø¬Ù„Ø©', '');
          select.add(option);
        }

        select.disabled = false;
      } catch (error) {
        console.error('Error loading families:', error);
        select.innerHTML = '<option value="">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø±</option>';
        select.disabled = false;
      }
    }

       async function loadMonthlyReport() {
      const month = document.getElementById('monthSelect').value;
      const familyId = document.getElementById('familySelect').value;
      const blocksDiv = document.getElementById('servantsBlocks');
      const summaryBody = document.getElementById('familySummaryBody');
      const summaryTable = document.querySelector('.summary-table');

      if (!month || !familyId) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø£Ø³Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      
      const response = await fetch(`${API_BASE}/admin/monthly-serviced/${month}/${familyId}`);
      const data = await response.json();
      summaryTable.style.display = 'table';
      document.getElementById('monthlySummaryTitle').style.display = 'block';

      blocksDiv.innerHTML = '';
      summaryBody.innerHTML = '';

      if (data.success && Array.isArray(data.serviced) && data.serviced.length > 0) {
        // Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ø³Ù†Ø© Ù…Ù† Ø£ÙˆÙ„ ØªØ§Ø±ÙŠØ® Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const firstDate = data.serviced.find(s => s.sessions.length > 0)?.sessions[0]?.date;
        const year = firstDate ? parseInt(firstDate.slice(0,4),10) : new Date().getFullYear();

        // Ø¹Ø¯Ø¯ Ø¬Ù…Ø¹ Ø§Ù„Ø´Ù‡Ø± Ù…Ù† Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
        const totalFridaysInMonth = countFridaysInMonth(month, year);

        // ÙƒÙ„ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
        const allDates = [...new Set(
          data.serviced.flatMap(s => Array.isArray(s.sessions) ? s.sessions.map(x => x.date) : [])
        )].sort();

        let totalSessions = 0, totalPresent = 0, totalServiced = 0;
        const filteredServiced = data.serviced;

        const groupedByServant = {};
        filteredServiced.forEach(s => {
          if (!groupedByServant[s.servant_name]) {
            groupedByServant[s.servant_name] = [];
          }
          groupedByServant[s.servant_name].push(s);
        });

        const table = document.createElement('table');
        table.className = 'table table-bordered';
        table.innerHTML = `
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ø¯Ù…</th>
              <th>Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…</th>
              ${allDates.map(d => `<th>${d}</th>`).join('')}
              <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(groupedByServant).map(([servantName, records]) => {
              return records.map((s, index) => {
                const presentCount = s.sessions.filter(x => x.status === 'Present').length;
                const percentage = totalFridaysInMonth > 0 ? Math.round((presentCount / totalFridaysInMonth) * 100) : 0;

                totalServiced++;
                totalSessions += totalFridaysInMonth;
                totalPresent += presentCount;

                return `
                  <tr>
                    ${index === 0 ? `<td rowspan="${records.length}">${servantName}</td>` : ''}
                    <td>${s.serviced_name}</td>
                    ${allDates.map(d => {
                      const session = s.sessions.find(x => x.date === d);
                      return `<td>${session ? (session.status === 'Present' ? '1' : '0') : '-'}</td>`;
                    }).join('')}
                    <td>${percentage}%</td>
                  </tr>
                `;
              }).join('');
            }).join('')}
          </tbody>
        `;
        blocksDiv.appendChild(table);

        const familyPercentage = totalSessions > 0 ? Math.round((totalPresent / totalSessions) * 100) : 0;
        summaryBody.innerHTML = `
          <tr>
            <td>${totalServiced}</td>
            <td>${totalPresent}</td>
            <td>${totalSessions}</td>
            <td>${familyPercentage}%</td>
          </tr>
        `;
      } else {
        blocksDiv.innerHTML = '<p>âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</p>';
      }
    }
  </script>
</body>
</html>
